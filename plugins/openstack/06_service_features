#!/usr/bin/python3
import re
import os


# HOTSOS GLOBALS
VERBOSITY_LEVEL = int(os.environ.get('VERBOSITY_LEVEL', 0))
DATA_ROOT = os.environ.get('DATA_ROOT', '/')

CONFIG_FILES = {"neutron": {"main": "etc/neutron/neutron.conf",
                            "openvswitch_agent":
                            "etc/neutron/plugins/ml2/openvswitch_agent.ini",
                            "l3_agent": "etc/neutron/l3_agent.ini",
                            "dhcp_agent": "etc/neutron/dhcp_agent.ini"},
                "nova": {"main": "etc/nova/nova.conf"}}

FEATURES = {"neutron": {"main": ["availability_zone"],
                        "openvswitch_agent": ["l2_population"],
                        "l3_agent": ["agent_mode", "ovs_use_veth"],
                        "dhcp_agent": ["enable_metadata_network",
                                       "enable_isolated_metadata",
                                       "ovs_use_veth"]},
            "nova": {"main": ["vcpu_pin_set", "cpu_shared_set",
                              "cpu_dedicated_set"]}}

# checked against neutron
DEFAULTS = {"neutron": {"dhcp_agent": {"enable_metadata_network": False,
                                       "enable_isolated_metadata": False}}}

SERVICE_FEATURES = {}


def get_service_features():
    for service in FEATURES:
        for module in FEATURES[service]:
            cfg = os.path.join(DATA_ROOT, CONFIG_FILES[service][module])
            if not os.path.exists(cfg):
                continue

            if service not in SERVICE_FEATURES:
                SERVICE_FEATURES[service] = {}

            for key in FEATURES[service][module]:
                for line in open(cfg).readlines():
                    ret = re.compile(r"^{}\s*=\s*(.+)\s*".format(key)
                                     ).match(line)
                    if ret:
                        if module not in SERVICE_FEATURES[service]:
                            SERVICE_FEATURES[service][module] = {}

                        if module in SERVICE_FEATURES[service]:
                            SERVICE_FEATURES[service][module][key] = ret[1]

                        break

                if key not in SERVICE_FEATURES[service].get(module, {}):
                    if key in DEFAULTS.get(service, {}).get(module, {}):
                        default = DEFAULTS[service][module][key]
                        if module not in SERVICE_FEATURES[service]:
                            SERVICE_FEATURES[service][module] = {key: default}
                        else:
                            SERVICE_FEATURES[service][module][key] = default


if __name__ == "__main__":
    get_service_features()
    if SERVICE_FEATURES:
        print("  features:")
        for service in SERVICE_FEATURES:
            if not SERVICE_FEATURES[service]:
                continue
            print("    {}:".format(service))
            for module in SERVICE_FEATURES[service]:
                for key in SERVICE_FEATURES[service][module]:
                    value = SERVICE_FEATURES[service][module][key]
                    print("      {}: {}".format(key, value))
