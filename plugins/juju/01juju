#!/usr/bin/python3
import re
import os

from common import helpers

# HOTSOS GLOBALS
VERBOSITY_LEVEL = int(os.environ.get('VERBOSITY_LEVEL', 0))
DATA_ROOT = os.environ.get('DATA_ROOT', '/')

JUJU_LOG_PATH = os.path.join(DATA_ROOT, "var/log/juju")

print("juju:")

machine_running = set()
machine_stopped = set()
ps_machines = set()
log_machines = set()

for line in helpers.get_ps():
    if "machine-" in line:
        ret = re.compile(r".+machine-([0-9]+).*").match(line)
        if ret:
            ps_machines.add(ret[1])

for f in os.listdir(JUJU_LOG_PATH):
    ret = re.compile(r"machine-([0-9]+)\.log.*").match(f)
    if ret:
        log_machines.add(ret[1])

combined_machines = ps_machines.union(log_machines)

for machine in combined_machines:
    agent_conf = os.path.join(DATA_ROOT,
                              "var/lib/juju/agents/machine-{}/agent.conf".
                              format(machine))
    version = "unknown"
    if os.path.exists(agent_conf):
        for line in open(agent_conf).readlines():
            ret = re.compile(r"upgradedToVersion:\s+(.+)").match(line)
            if ret:
                version = ret[1]

    if machine in ps_machines:
        machine_running.add("{} (version={})".format(machine, version))
    else:
        machine_stopped.add(machine)


print("  machines:")
if machine_running:
    print("    running:")
    for m in machine_running:
        print("      - {}".format(m))

if machine_stopped:
    print("    stopped:")
    for m in machine_stopped:
        print("      - {}".format(m))
